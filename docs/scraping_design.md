# stats.gjf.or.kr 수집 설계서 (관계자 로그인 기반)

이 문서는 "어떻게 접속해서 어떤 방식으로 데이터를 가져올지"를 실제 구현 가능한 수준으로 정리한 설계서입니다.

## 1. 목표
- 대상: `https://stats.gjf.or.kr` 조기경보 서비스
- 로그인: 좌측 하단 `관계자` 버튼 → ID/PW
- 수집 범위: 고용보험 6개 지표
- 지역 범위: 전국, 17개 시도, 경기도 31개 시군
- 시점: 현재값, 2개월 전 값
- 신호등: 정상(녹색), 관심(노랑), 위기(빨강)

## 2. 기술 선택
- 브라우저 자동화: Playwright(파이썬)
- 이유:
  - 로그인/동적 렌더링(UI 상호작용) 안정성 높음
  - 대기(wait)·스크린샷·네트워크 추적이 쉬움

## 3. 접속/로그인 상세 절차
1. `page.goto("https://stats.gjf.or.kr")`
2. 좌측 하단 `관계자` 버튼 클릭
3. 로그인 모달/페이지에서 ID/PW 입력
4. 로그인 완료 표시(예: 사용자명, 로그아웃 버튼, 대시보드 요소) 확인
5. 로그인 실패 시 재시도 1회 후 실패 종료

### 3.1 셀렉터 수집 규칙
- 우선순위: `data-testid` > 고정 id/class > 텍스트 기반
- 초기에 아래 셀렉터를 `config/selectors.json`으로 분리 권장:
  - 관계자 버튼
  - 아이디 입력
  - 비밀번호 입력
  - 로그인 제출 버튼
  - 로그인 성공 검증 요소
  - 지표 탭 / 지역 탭 / 월 선택 요소

## 4. 데이터 수집 상세 절차

### 4.1 기준 월 설정
- 상단 월 표시(예: `2025년 11월`) 텍스트를 읽어 `snapshot_month` 생성
- 월말 실행 시 해당 월 스냅샷으로 저장

### 4.2 고용보험 탭 이동
- 분석선택에서 `고용보험` 버튼 클릭
- 렌더링 완료 대기(`networkidle` + 핵심 카드 요소 노출)

### 4.3 지역 레벨별 반복 수집
- `region_level` 순서:
  1) `national` (전국)
  2) `province` (17개 시도)
  3) `gyeonggi_city` (경기도 31개 시군)

각 레벨마다:
1. 지역 필터 클릭
2. 카드/테이블/지도 툴팁에서 지표 6개 추출
3. 행 단위로 정규화하여 리스트에 append

### 4.4 추출 스키마(확정)
- `snapshot_month` (YYYY-MM)
- `region_level` (`national`/`province`/`gyeonggi_city`)
- `region_name`
- `indicator` (6개 지표명)
- `current_value`
- `current_signal` (`정상`/`관심`/`위기`)
- `prev_2m_value`
- `prev_2m_signal` (`정상`/`관심`/`위기`)
- `collected_at` (ISO8601)

## 5. 신호등/값 파싱 규칙
- 텍스트 우선 파싱: 버튼 라벨(`정상`, `관심`, `위기`) 그대로 저장
- 색상만 있는 경우 보조 규칙:
  - 녹색 계열 class/style → `정상`
  - 노랑/주황 계열 class/style → `관심`
  - 빨강 계열 class/style → `위기`
- 숫자 파싱 시 `,` 제거 후 int 변환

## 6. 오류 처리
- 공통 타임아웃: 15~30초
- 실패 시:
  - 페이지 스크린샷 저장 (`artifacts/login_failed.png` 등)
  - 실패 단계/셀렉터/URL 로깅
  - GitHub Actions job 실패 처리

## 7. 월말 실행 방식
- Actions는 매일 1회 실행
- `scripts/run_if_month_end.sh`에서 월말일 때만 수집 실행
- 실행 성공 시 `data/snapshots/YYYY-MM.csv` 커밋

## 8. 보고서 형태(초안)

### 페이지 1: 월간 요약
- 총 지역 수(레벨별)
- 신호등 분포(정상/관심/위기)
- 전월 대비 위기 지역 증감

### 페이지 2: 지역 상세 테이블
- 필터: 기준월, 지역레벨, 지표
- 컬럼: 현재값/2개월전/증감/현재신호/2개월전신호
- 정렬: 위기 우선, 관심 다음

### 페이지 3: 경기도 31개 시군 집중 보기
- 지표 선택 시 시군별 신호등 매트릭스
- 필요 시 지도(선택)

## 9. 구현 전 반드시 확정할 항목
1. 로그인 후 첫 진입 URL이 고정인지?
2. 전국/17개 시도/31개 시군 데이터가 한 화면에서 모두 접근 가능한지?
3. `2개월 전`이 고정 레이블인지, 월 선택에 따라 자동 변경되는지?
4. 지표별 단위(명/개/%)가 무엇인지?
5. 같은 지역/지표에서 값이 비어있는 경우 처리 규칙?
